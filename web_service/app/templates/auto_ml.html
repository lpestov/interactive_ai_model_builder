{% extends "base.html" %}
{% block title %}AutoML{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}
{% block body %}
<div class="container mt-5">
    <div class="d-flex align-items-center mb-4">
        <h1 class="text-primary me-3">
            <i class="bi bi-magic"></i> AutoML Training
        </h1>
    </div>

    <form action="{{ url_for('auto_ml.train_model') }}" method="post" enctype="multipart/form-data">
        <!-- Блок выбора датасета -->
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-database me-2"></i>Dataset Selection</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="dataset" class="form-label text-primary fw-medium">Select Dataset</label>
                    <select class="form-select border-primary" id="dataset" name="dataset">
                        {% for ds in datasets %}
                        <option value="{{ ds.id }}">{{ ds.file_name }} (id: {{ ds.id }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Блок 1: Выбор ML модели и параметров -->
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Model Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="model" class="form-label text-primary fw-medium">Base Model</label>
                            <select class="form-select border-primary" id="model" name="model">
                                {% for model in sklearn_models %}
                                <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6 class="text-primary mb-3"><i class="bi bi-toggles2 me-2"></i>Model Parameters Space</h6>
                    <div id="model_param_space" class="row g-3"></div>
                </div>
            </div>
        </div>

        <!-- Блок 2: Алгоритм подбора гиперпараметров -->
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear-wide-connected me-2"></i>Hyperparameter Optimization</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="hpo_method" class="form-label text-primary fw-medium">Optimization Algorithm</label>
                            <select class="form-select border-primary" id="hpo_method" name="hpo_method">
                                {% for key, method in hpo_methods.items() %}
                                <option value="{{ key }}">{{ method.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6 class="text-primary mb-3"><i class="bi bi-sliders me-2"></i>Algorithm Parameters</h6>
                    <div id="hpo_params" class="row g-3"></div>
                </div>
            </div>
        </div>

        <!-- Кнопка запуска -->
        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-lightning-charge me-2"></i>Start AutoML Training
            </button>
        </div>
    </form>
</div>

<script>
// Модифицированный JavaScript для раздельных блоков
document.getElementById("model").addEventListener("change", function(){
  var model = this.value;
  fetch("/get_model_param_space?model=" + model)
    .then(response => response.json())
    .then(data => {
       var container = document.getElementById("model_param_space");
       container.innerHTML = '';
       for(var param in data){
         var config = data[param];
         var div = document.createElement("div");
         div.className = "col-md-6";
         var innerDiv = document.createElement("div");
         innerDiv.className = "mb-3 p-3 border rounded bg-light";

         var label = document.createElement("label");
         label.className = "form-label text-primary small fw-medium";
         label.innerHTML = param + " <span class='text-muted'>(range)</span>";
         innerDiv.appendChild(label);

         var inputGroup = document.createElement("div");
         inputGroup.className = "row g-2";

         // Min input
         var col1 = document.createElement("div");
         col1.className = "col";
         var inputLow = document.createElement("input");
         inputLow.className = "form-control border-primary";
         inputLow.name = "model_param_" + param + "_low";
         inputLow.type = "number";
         inputLow.step = (config.type === "float") ? "0.01" : "1";
         inputLow.placeholder = "Min value";
         inputLow.value = config.default_low;
         col1.appendChild(inputLow);
         inputGroup.appendChild(col1);

         // Max input
         var col2 = document.createElement("div");
         col2.className = "col";
         var inputHigh = document.createElement("input");
         inputHigh.className = "form-control border-primary";
         inputHigh.name = "model_param_" + param + "_high";
         inputHigh.type = "number";
         inputHigh.step = (config.type === "float") ? "0.01" : "1";
         inputHigh.placeholder = "Max value";
         inputHigh.value = config.default_high;
         col2.appendChild(inputHigh);
         inputGroup.appendChild(col2);

         innerDiv.appendChild(inputGroup);
         div.appendChild(innerDiv);
         container.appendChild(div);
       }
    });
});

document.getElementById("hpo_method").addEventListener("change", function(){
  var method = this.value;
  fetch("/get_hpo_params?method=" + method)
    .then(response => response.json())
    .then(data => {
       var container = document.getElementById("hpo_params");
       container.innerHTML = "";
       for(var param in data){
         var config = data[param];
         var div = document.createElement("div");
         div.className = "col-md-6";
         var innerDiv = document.createElement("div");
         innerDiv.className = "mb-3 p-3 border rounded bg-light";

         var label = document.createElement("label");
         label.className = "form-label text-primary small fw-medium";
         label.innerHTML = (config.label || param) + " <span class='text-muted'>(" + config.type + ")</span>";
         innerDiv.appendChild(label);

         if(config.type === "select"){
            var select = document.createElement("select");
            select.className = "form-select border-primary";
            select.name = "hpo_param_" + param;
            config.options.forEach(function(option){
               var opt = document.createElement("option");
               opt.value = option;
               opt.text = option;
               if(option === config.default) opt.selected = true;
               select.appendChild(opt);
            });
            innerDiv.appendChild(select);
         } else {
            var input = document.createElement("input");
            input.className = "form-control border-primary";
            input.type = (config.type === "float" || config.type === "int") ? "number" : "text";
            input.name = "hpo_param_" + param;
            input.value = config.default;
            if(config.type === "float") input.step = "0.01";
            if(config.type === "int") input.step = "1";
            innerDiv.appendChild(input);
         }
         div.appendChild(innerDiv);
         container.appendChild(div);
       }
    });
});

// Инициализация
document.getElementById("model").dispatchEvent(new Event("change"));
document.getElementById("hpo_method").dispatchEvent(new Event("change"));
</script>
{% endblock %}